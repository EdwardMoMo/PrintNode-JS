var PrintNode=function(){"use strict";function e(){}function t(e,r){if(e.publish||e.subscribe)throw"publify can't operate on this object there's a collision with existing obj properties";var i={};return e.publish=function(e,o,a){a=a||r;var s=t.topicExplodeHierarchy(e),c=t.getSubscribersFromTopicHierarchy(s,i);m(c,function(t){var r={subscription:e,originalSubscription:t[0],payload:o,data:t[1].data};try{t[1].fn.call(t[1].context,o,r)}catch(i){r.exception=i,r.fn=t[1].fn,r.context=t[1].context,a(new n("RunTime","Exception thrown in subscription callback - "+i),r)}})},e.subscribe=function(r,n,o){if(b(r)){if(!T(r,y))throw"subscription topic is a array but not a array of strings";r=r.map(t.escapeTopicFragment).join(".")}else if(!y(r))throw"subscription topic must either be a string or a array of strings";if(!v(n))throw"subscription call backs must be functions";o=o||{};var a={fn:n,data:o.data||null,context:o.context||e};return void 0===i[r]?i[r]=[a]:i[r].push(a),this},e.unsubscribe=function(e){var t=0;if(y(e))void 0!==i[e]&&(t=i[e].length,delete i[e]);else{if(!v(e))throw"you can only unsubscribe strings or functions";var r,n,o,a=[];for(r in i)n=A(i[r]),o=i[r].length-n.length,t+=o,0===n.length?a.push(r):o&&(i[r]=n);m(a,function(e){delete i[e]})}return t},e.publish}function r(e){try{e=JSON.parse(e)}catch(t){throw new n("Server","server->client message not valid javascript")}if(!b(e)||3!==e.length)throw new n("Server","server->client message framing error");this.typ=e[0],this.message=e[1],this.payload=e[2]}function n(e,t){if(!n.CODES[e])throw"unknown error code '"+e+"'";this.code=e,this.message=t||n.CODES[e]}function i(e,t,r,i,o){function a(a,u,l){var p,f=void 0===l?t:l,h=Date.now();c++,f?(l=c,p=""+c,s[p]=[setTimeout(function(){var e=Date.now()-h;i(new n("Server","No ack recieved"),{timeout:!0,timeoutDuration:e,message:a,payload:u})},r),h]):l=null;var d;try{d=JSON.stringify([l,a,u])}catch(m){return i(new n("BadArguments","Not possible to JSON encode all message arguments"),{timeout:!1,message:a,payload:u}),!1}try{e.send(d)}catch(m){return i(new n("Socket","Send failed. It is likely the socket isn't open"),{timeout:!1,message:a,payload:u}),!1}return o(d),!0}var s={},c=0;a.shutdown=function(){for(var e in s)clearTimeout(s[e][0]);s={}};var u=[],l=50;return a.ack=function(e){e=""+e;var t=s[e];return delete s[e],void 0===t?void i(new n("Server","Unexpected ack recieved; either this message didn't request a ack or we've already recieved it."),{timeout:!1}):(clearTimeout(t[0]),u.push(Date.now()-t[1]),void(u.length>l&&u.shift()))},a.getNumMessages=function(){return c},a.getDebugInfo=function(){for(var e=0,t=0,r=u.length;r>t;t++)e+=u[t];return{numMessages:c,meanAck:e>0?parseInt(e/r,10):0,accDurations:u}},a}function o(e,t){return function(){t();try{e.close()}catch(r){return f.log("failed to close socket",r),!1}return!0}}function a(e){return e.scheme+"://"+e.server+"/ws/"+e.version}function s(e){this.maxSubscriptions=e,this.subscriptions={},this.subscriptionCount=0,this.getSubscriptionId=function(){var e=0;return function(){return e++}}()}function c(e){for(var t in e)this[t]=e[t]}function u(e,t){var r,i,o={},a=[];for(r in e)o[r]=encodeURIComponent(e[r]),a.push(r);if(0===a.length&&t)i=["scales"];else if(S(o,["computerId","deviceName","deviceNum"]))i=["computer",o.computerId,"scale",o.deviceName,o.deviceNum];else if(S(o,["computerId","deviceName"]))i=["computer",o.computerId,"scales",o.deviceName];else{if(!S(o,["computerId"]))throw new n("RunTime","Options key combination ("+a.join(", ")+") for getting scales data; please refer to documentation.");i=["computer",o.computerId,"scales"]}return i.join("/")}function l(h,d,b){function T(e){K=e,U("system.state."+K,K)}function S(){F(),N.timeout&&clearTimeout(N.timeout);var e=Array.prototype.slice.call(arguments);b&&b.apply(H,e),1===e.length&&(e=e[0]),U(["error"],e,function(){f.error("error in error callback",e)})}function A(e){if(clearTimeout(N.timeout),e.error?(T("UNAUTHENTICATED"),U("authenticate.error",e),F()):(T("AUTHENTICATED"),R=new s(e.maxSubscriptions),U("authenticate.ok",e)),d)try{d.call(H,e)}catch(t){S("Exception thrown in authentication callback:",t)}}function N(){T("UNAUTHENTICATED");var e={timeout:!0,error:"Server timed out"};if(U("authenticate.error",e),d)try{d.call(H,e)}catch(t){S("Exception thrown in authentication callback:",t)}S(new n("Server","Server failed to authenticate in time"),e)}function E(e){L=!0,N.timeout=setTimeout(N,h.authTimeout),T("AUTHENTICATING"),U("system.socket.open",e),j("authenticate",{apiKey:h.apiKey},!0)}function x(e){L=!1,U("system.socket.close",e),T("DISCONNECTED")}function I(e){U("system.socket.error",e),S(new n("Socket"),{socket:!0,socketError:e})}function C(e){var t;U("system.socket.message",e);try{t=new r(e.data)}catch(i){return void S(i,{timeout:!1,data:e.data})}switch(t.typ){case"system":switch(t.message){case"authenticateResponse":A(t.payload);break;case"hi":L=t.payload;break;case"rateLimit":S(new n("RateLimit","PrintNode is applying rate limits"),t.payload);break;default:f.log("unhandled system message",t,t.payload)}break;case"protocol":switch(t.message){case"ack":j.ack(t.payload);break;default:f.log("unhandled protocol message",t,t.payload)}break;case"publish":var o,a=t.message,s=t.payload[0];if(o=R.trigger(s,t.payload[1],S),!1!==o){var c=function(e){U(e,o.payload)};m(o.additionalTopics,c),m(a,c)}break;default:f.log("unhandled message type",t,t.payload)}}function D(e){U("system.socket.sent",e)}function O(t,r,i,o,a){if(!y(t))throw new n("BadArguments","Subscription path should be a string");if(!R)throw new n("RunTime","Cannot create subscriptions until authenticated");r=r||e,a=a||[];var s=R.add(t,r,i,o,a);return j("subscribe",[s,t],!0),s}if(!l.isSupported())throw new n("NotSupported","Native WebSocker support is missing");if(d&&!v(d))throw new n("BadArguments","If set the authCallback argument should be a function");if(b&&!v(b))throw new n("BadArguments","If set the errorCallback argument should be a function");if(!h||!h.apiKey)throw new n("BadArguments","Options argument expected to be a object with property 'apiKey'");if(void 0!==h.ack&&!w(h.ack))throw new n("BadArguments","options.ack should be literal boolean");if(void 0!==h.ackTimeout&&!k(h.ackTimeout))throw new n("BadArguments","options.ackTimeout should be a int");if(void 0!==h.authTimeout&&!k(h.authTimeout))throw new n("BadArguments","options.authTimeout should be a int");h=g({version:p,server:"api.printnode.com",scheme:"wss",ack:!1,ackTimeout:1e4,authTimeout:5e3},h);var R,B,j,F,H=this,U=t(this,S),K="NOT_STARTED",L=!1;this.getState=function(){return K},this.isConnected=function(){return L},B=new WebSocket(a(h)),B.onopen=E,B.onclose=x,B.onerror=I,B.onmessage=C,j=i(B,h.ack,h.ackTimeout,S,D),F=o(B,j.shutdown),this.removeServerSubscription=function(e){var t=R.remove(e);return t.length&&j("unsubscribe",t,!0),t},this.getScales=function(e,t,r){var n=u(e,!0);return O("/"+n+"/",t,r,c.factory,["scales"])}}var p="0.1.0",f=window.console||{log:e,error:e},h=Object.prototype.hasOwnProperty,d=Array.prototype.forEach,m=function(e,t,r){if(null!==e)if(d&&e.forEach===d)e.forEach(t,r);else if(e.length===+e.length){for(var n=0,i=e.length;i>n;n++)if(n in e&&void 0===t.call(r,e[n],n,e))return}else for(var o in e)if(h.call(e,o)&&void 0===t.call(r,e[o],o,e))return},g=function(e){return m(Array.prototype.slice.call(arguments,1),function(t){for(var r in t)void 0!==t[r]&&(e[r]=t[r])}),e},b=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)},v=function(e){return"function"==typeof e||!1},y=function(e){return"string"==typeof e||!1},w=function(e){return!0===e||!1===e},k=function(e){return parseInt(e,10)===e},T=function(e,t){for(var r=0,n=e.length;n>r;r++)if(!t(e[r]))return!1;return!0},S=function(e,t){for(var r=0,n=t.length;n>r;r++)if(void 0===e[t[r]])return!1;return!0},A=function(e,t){if(-1===e.indexOf(t))return e;for(var r=[],n=0,i=e.length;i>n;n++)t!==e[n]&&r.push(e[n]);return r};return t.topicExplodeHierarchy=function(e){var r,n;if(b(e)){if(!T(e,y))throw"subscription topic is a array but not a array of strings";n=e}else{if(!y(e))throw"you can only publish string or array topics";n=t.topicExplodeFragments(e)}r=[t.escapeTopicFragment(n[0])];for(var i=1,o=n.length;o>i;i++)r[i]=r[i-1]+"."+t.escapeTopicFragment(n[i]);return r},t.getSubscribersFromTopicHierarchy=function(e,t){var r=[];return m(e,function(e){var n=t[e];if(n)for(var i=0,o=n.length;o>i;i++)r.push([e,n[i]])}),r},t.escapeTopicFragment=function(e){return e.replace(/\\/g,"\\\\").replace(/\./g,"\\.")},t.topicExplodeFragments=function(e){for(var t,r=[""],n=0,i=0,o=e.length,a=!1;o>i;i++)t=e.charAt(i),a?(r[n]+=t,a=!1):"\\"===t?a=!0:"."===t?r[++n]="":r[n]+=t;return r},n.prototype.toString=function(){return"PrintNode "+this.code+" exception: "+this.message},n.CODES={NotSupported:"This feature isn't supported",BadArguments:"Bad arguments passed",Server:"Server error",Socket:"Socket error",RateLimit:"Rate limit error",Internal:"Internal error",RunTime:"RunTime"},s.prototype.add=function(e,t,r,i,o){if(!v(t))throw new n("BadArguments","Subscription callback must be a function if is defined.");if(!v(i))throw new n("Internal","Subscription handler must be a function.");if(!b(o))throw new n("Internal","Additional topics must be a array.");if(this.subscriptionCount===this.maxSubscriptions)throw new n("RunTime","Max number of subscriptions reached; unable to add more.");m(this.subscriptions,function(t){if(e===t)throw new n("BadArguments","Subscription '"+e+"' already added.")});var a=this.getSubscriptionId();return this.subscriptionCount++,this.subscriptions[a]=[a,e,t,r,i,o],a},s.prototype.remove=function(e){var t,r,i=[];if(k(e))t=function(t){return t[0]===e};else if(y(e))t=function(t){return t[1]===e};else if(v(e))t=function(t){return t[2]===e};else{if(void 0!==e)throw new n("BadArguments","Can only remove subscription by id, path or callback.");t=function(){return!0}}for(r in this.subscriptions)t(this.subscriptions[r])&&i.push(this.subscriptions[r][0]);return m(i,function(e){delete this.subscriptions[e]},this),i},s.prototype.trigger=function(e,t,r){var i=this.subscriptions[e];if(void 0===i)return!1;var o,a=i[1],s=i[2],c=i[3]||a,u=i[4],l=i[5],p={id:e,path:a};try{o=u(t)}catch(f){o=t}try{s.call(c,o,p)}catch(f){p.exception=f,p.fn=s,p.context=c,r(new n("RunTime","Exception thrown in subscription callback - "+f),p)}return{payload:o,additionalTopics:l}},c.prototype.getLatency=function(){var e=new Date(this.clientReportedCreateTimestamp),t=new Date;return t.getTime()-e.getTime()},c.factory=function(e){return new c(e)},l.isSupported=function(){return!!window.WebSocket},{WebSocket:l,ScalesMeasurement:c,Error:n}}();