var PrintNode=function(){"use strict";function t(){}function e(t,r){if(t.publish||t.subscribe)throw"publify can't operate on this object there's a collision with existing obj properties";var i={};return t.publish=function(t,o,a){a=a||r;var s=e.topicExplodeHierarchy(t),c=e.getSubscribersFromTopicHierarchy(s,i);A(c,function(e){var r={subscription:t,originalSubscription:e[0],payload:o,data:e[1].data};try{e[1].fn.call(e[1].context,o,r)}catch(i){r.exception=i,r.fn=e[1].fn,r.context=e[1].context,a(new n("RunTime","Exception thrown in subscription callback - "+i),r)}})},t.subscribe=function(r,n,o){if(N(r)){if(!D(r,I))throw"subscription topic is a array but not a array of strings";r=r.map(e.escapeTopicFragment).join(".")}else if(!I(r))throw"subscription topic must either be a string or a array of strings";if(!E(n))throw"subscription call backs must be functions";o=o||{};var a={fn:n,data:o.data||null,context:o.context||t};return void 0===i[r]?i[r]=[a]:i[r].push(a),this},t.unsubscribe=function(t){var e=0;if(I(t))void 0!==i[t]&&(e=i[t].length,delete i[t]);else{if(!E(t))throw"you can only unsubscribe strings or functions";var r,n,o,a=[];for(r in i)n=j(i[r]),o=i[r].length-n.length,e+=o,0===n.length?a.push(r):o&&(i[r]=n);A(a,function(t){delete i[t]})}return e},t.publish}function r(t){try{t=JSON.parse(t)}catch(e){throw new n("Server","server->client message not valid javascript")}if(!N(t)||3!==t.length)throw new n("Server","server->client message framing error");this.typ=t[0],this.message=t[1],this.payload=t[2]}function n(t,e){if(!n.CODES[t])throw"unknown error code '"+t+"'";this.code=t,this.message=e||n.CODES[t]}function i(t,e,r,i,o){function a(a,u,p){var l,h=void 0===p?e:p,f=Date.now();c++,h?(p=c,l=""+c,s[l]=[setTimeout(function(){var t=Date.now()-f;i(new n("Server","No ack recieved"),{timeout:!0,timeoutDuration:t,message:a,payload:u})},r),f]):p=null;var d;try{d=JSON.stringify([p,a,u])}catch(m){return i(new n("BadArguments","Not possible to JSON encode all message arguments"),{timeout:!1,message:a,payload:u}),!1}try{t.send(d)}catch(m){return i(new n("Socket","Send failed. It is likely the socket isn't open"),{timeout:!1,message:a,payload:u}),!1}return o(d),!0}var s={},c=0;a.shutdown=function(){for(var t in s)clearTimeout(s[t][0]);s={}};var u=[],p=50;return a.ack=function(t){t=""+t;var e=s[t];return delete s[t],void 0===e?void i(new n("Server","Unexpected ack recieved; either this message didn't request a ack or we've already recieved it."),{timeout:!1}):(clearTimeout(e[0]),u.push(Date.now()-e[1]),void(u.length>p&&u.shift()))},a.getNumMessages=function(){return c},a.getDebugInfo=function(){for(var t=0,e=0,r=u.length;r>e;e++)t+=u[e];return{numMessages:c,meanAck:t>0?parseInt(t/r,10):0,accDurations:u}},a}function o(t,e){return function(){e();try{t.close()}catch(r){return T.log("failed to close socket",r),!1}return!0}}function a(t){return t.scheme+"://"+t.server+"/ws/"+t.version}function s(t){this.maxSubscriptions=t,this.subscriptions={},this.subscriptionCount=0,this.getSubscriptionId=function(){var t=0;return function(){return t++}}()}function c(t){for(var e in t)this[e]=t[e]}function u(t,e){var r,i,o={},a=[];for(r in t)o[r]=encodeURIComponent(t[r]),a.push(r);if(0===a.length&&e)i=["scales"];else if(B(o,["computerId","deviceName","deviceNum"]))i=["computer",o.computerId,"scale",o.deviceName,o.deviceNum];else if(B(o,["computerId","deviceName"]))i=["computer",o.computerId,"scales",o.deviceName];else{if(!B(o,["computerId"]))throw new n("RunTime","Options key combination ("+a.join(", ")+") for getting scales data; please refer to documentation.");i=["computer",o.computerId,"scales"]}return i.join("/")}function p(l,h,f){function d(t){q=t,M("system.state."+q,q)}function m(){H(),b.timeout&&clearTimeout(b.timeout);var t=Array.prototype.slice.call(arguments);f&&f.apply(U,t),1===t.length&&(t=t[0]),M(["error"],t,function(){T.error("error in error callback",t)})}function g(t){if(clearTimeout(b.timeout),t.error?(d("UNAUTHENTICATED"),M("authenticate.error",t),H()):(d("AUTHENTICATED"),D=new s(t.maxSubscriptions),M("authenticate.ok",t)),h)try{h.call(U,t)}catch(e){m("Exception thrown in authentication callback:",e)}}function b(){d("UNAUTHENTICATED");var t={timeout:!0,error:"Server timed out"};if(M("authenticate.error",t),h)try{h.call(U,t)}catch(e){m("Exception thrown in authentication callback:",e)}m(new n("Server","Server failed to authenticate in time"),t)}function y(t){P=!0,b.timeout=setTimeout(b,l.authTimeout),d("AUTHENTICATING"),M("system.socket.open",t),j("authenticate",{apiKey:l.apiKey},!0)}function v(t){P=!1,M("system.socket.close",t),d("DISCONNECTED")}function S(t){M("system.socket.error",t),m(new n("Socket"),{socket:!0,socketError:t})}function k(t){var e;M("system.socket.message",t);try{e=new r(t.data)}catch(i){return void m(i,{timeout:!1,data:t.data})}switch(e.typ){case"system":switch(e.message){case"authenticateResponse":g(e.payload);break;case"hi":P=e.payload;break;case"rateLimit":m(new n("RateLimit","PrintNode is applying rate limits"),e.payload);break;default:T.log("unhandled system message",e,e.payload)}break;case"protocol":switch(e.message){case"ack":j.ack(e.payload);break;default:T.log("unhandled protocol message",e,e.payload)}break;case"publish":var o,a=e.message,s=e.payload[0];if(o=D.trigger(s,e.payload[1],m),!1!==o){var c=function(t){M(t,o.payload)};A(o.additionalTopics,c),A(a,c)}break;default:T.log("unhandled message type",e,e.payload)}}function N(t){M("system.socket.sent",t)}function R(e,r,i,o,a){if(!I(e))throw new n("BadArguments","Subscription path should be a string");if(!D)throw new n("RunTime","Cannot create subscriptions until authenticated");r=r||t,a=a||[];var s=D.add(e,r,i,o,a);return j("subscribe",[s,e],!0),s}if(!p.isSupported())throw new n("NotSupported","Native WebSocker support is missing");if(h&&!E(h))throw new n("BadArguments","If set the authCallback argument should be a function");if(f&&!E(f))throw new n("BadArguments","If set the errorCallback argument should be a function");if(!l||!l.apiKey)throw new n("BadArguments","Options argument expected to be a object with property 'apiKey'");if(void 0!==l.ack&&!C(l.ack))throw new n("BadArguments","options.ack should be literal boolean");if(void 0!==l.ackTimeout&&!O(l.ackTimeout))throw new n("BadArguments","options.ackTimeout should be a int");if(void 0!==l.authTimeout&&!O(l.authTimeout))throw new n("BadArguments","options.authTimeout should be a int");l=x({version:w,server:"api.printnode.com",scheme:"wss",ack:!1,ackTimeout:1e4,authTimeout:5e3},l);var D,B,j,H,U=this,M=e(this,m),q="NOT_STARTED",P=!1;this.getState=function(){return q},this.isConnected=function(){return P},B=new WebSocket(a(l)),B.onopen=y,B.onclose=v,B.onerror=S,B.onmessage=k,j=i(B,l.ack,l.ackTimeout,m,N),H=o(B,j.shutdown),this.removeServerSubscription=function(t){var e=D.remove(t);return e.length&&j("unsubscribe",e,!0),e},this.getScales=function(t,e,r){var n=u(t,!0);return R("/"+n+"/",e,r,c.factory,["scales"])}}function l(t){var e,r=t.getResponseHeader("Content-Type");if(r&&"application/json"!==r.split(";")[0])throw new n("Server","Server has not responded with valid JSON Content-Type");try{e=JSON.parse(t.responseText)}catch(i){throw new n("Server","Server has not responded valid JSON, it returned; "+t.responseText)}return e}function h(t){var e=t.getAllResponseHeaders(),r={};if(!e)return r;for(var n=e.split("\r\n"),i=0,o=n.length;o>i;i++){var a=n[i],s=a.indexOf(": ");if(s>0){var c=a.substring(0,s),u=a.substring(s+2);r[c]=u}}return r}function f(t,e,r,n,i){this.xhr=t,this.reqMethod=e,this.reqUrl=r,this.reqBody=n,this.reqStart=i,this.reqEnd=new Date,this.response=l(t),this.headers=h(t)}function d(t,e,r,n){var i,o=U(),a=0,s="https://"+t.server+"/"+r,c=new Date,u=H();return t=x({timeoutDuration:3e3},t),t.timeoutDuration&&t.timeout&&(i=setTimeout(function(){if(o.onreadystatechange=function(){},o.abort(),t.timeout){try{t.timeout.call(t.ctx,s,t.timeoutDuration)}catch(e){T.error("exception thrown in timeout callback",e,t.timeout)}u(!1,["timeout"])}},t.timeoutDuration)),o.onreadystatechange=function(){if(4==o.readyState){i&&clearTimeout(i);var r=new f(o,e,s,n,c);if(r.isOk()){if(t.success){try{t.success.call(t.ctx,r.response,r)}catch(p){T.error("exception thrown in success callback",p,t.success,r)}u(!0,[r.response,r])}}else if(t.error){try{t.error.call(t.ctx,r.response,r)}catch(p){T.error("exception thrown in error callback",p,t.error,r)}u(!1,[r.response,r])}if(t.complete)try{t.complete.call(t.ctx,r)}catch(p){T.error("exception thrown in complete callback",p,t.complete,r)}}else if(t.progress)try{t.progress(++a)}catch(p){T.error("exception thrown progress callback",p,t.progress)}},o.open(e,s),t.auth.setXhrHeaders(o),("POST"===e||"PUT"===e||"PATCH"===e)&&(o.setRequestHeader("Content-Type","application/json"),n=JSON.stringify(n)),o.send(n),u}function m(){this.headers={}}function g(t){if(!I(t))throw"apiKey must be a string";this.setAuthorizationHeader(t,"")}function b(t,e){if(!I(t))throw"username must be a string";if(!I(e))throw"password must be a string";this.headers["X-Auth-With-Account-Credentials"]="true",this.setAuthorizationHeader(t,e)}function y(t){if(!I(t))throw"clientKey must be a string";this.headers["X-Auth-With-Client-Key"]="true",this.setAuthorizationHeader(t,"")}function v(t,e){if(e=e||{},!(t instanceof m))throw"auth argument isn't of the right type";this.options=x({version:null,server:"api.printnode.com",context:this},e),this._makeReqOptions=function(e){return x({},this.options,e||{},{auth:t})}}var w="0.1.0";if(!window.JSON)throw"Missing JSON support. You'll need to polyfil this";var T=window.console||{log:t,error:t},S=Object.prototype.hasOwnProperty,k=Array.prototype.forEach,A=function(t,e,r){if(null!==t)if(k&&t.forEach===k)t.forEach(e,r);else if(t.length===+t.length){for(var n=0,i=t.length;i>n;n++)if(n in t&&void 0===e.call(r,t[n],n,t))return}else for(var o in t)if(S.call(t,o)&&void 0===e.call(r,t[o],o,t))return},x=function(t){return A(Array.prototype.slice.call(arguments,1),function(e){for(var r in e)void 0!==e[r]&&(t[r]=e[r])}),t},N=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)},E=function(t){return"function"==typeof t||!1},I=function(t){return"string"==typeof t||!1},C=function(t){return!0===t||!1===t},O=function(t){return parseInt(t,10)===t},R=function(t){return"object"==typeof t},D=function(t,e){for(var r=0,n=t.length;n>r;r++)if(!e(t[r]))return!1;return!0},B=function(t,e){for(var r=0,n=e.length;n>r;r++)if(void 0===t[e[r]])return!1;return!0},j=function(t,e){if(-1===t.indexOf(e))return t;for(var r=[],n=0,i=t.length;i>n;n++)e!==t[n]&&r.push(t[n]);return r};e.topicExplodeHierarchy=function(t){var r,n;if(N(t)){if(!D(t,I))throw"subscription topic is a array but not a array of strings";n=t}else{if(!I(t))throw"you can only publish string or array topics";n=e.topicExplodeFragments(t)}r=[e.escapeTopicFragment(n[0])];for(var i=1,o=n.length;o>i;i++)r[i]=r[i-1]+"."+e.escapeTopicFragment(n[i]);return r},e.getSubscribersFromTopicHierarchy=function(t,e){var r=[];return A(t,function(t){var n=e[t];if(n)for(var i=0,o=n.length;o>i;i++)r.push([t,n[i]])}),r},e.escapeTopicFragment=function(t){return t.replace(/\\/g,"\\\\").replace(/\./g,"\\.")},e.topicExplodeFragments=function(t){for(var e,r=[""],n=0,i=0,o=t.length,a=!1;o>i;i++)e=t.charAt(i),a?(r[n]+=e,a=!1):"\\"===e?a=!0:"."===e?r[++n]="":r[n]+=e;return r},n.prototype.toString=function(){return"PrintNode "+this.code+" exception: "+this.message},n.CODES={NotSupported:"This feature isn't supported",BadArguments:"Bad arguments passed",Server:"Server error",Socket:"Socket error",RateLimit:"Rate limit error",Internal:"Internal error",RunTime:"RunTime"},s.prototype.add=function(t,e,r,i,o){if(!E(e))throw new n("BadArguments","Subscription callback must be a function if is defined.");if(!E(i))throw new n("Internal","Subscription handler must be a function.");if(!N(o))throw new n("Internal","Additional topics must be a array.");if(this.subscriptionCount===this.maxSubscriptions)throw new n("RunTime","Max number of subscriptions reached; unable to add more.");A(this.subscriptions,function(e){if(t===e)throw new n("BadArguments","Subscription '"+t+"' already added.")});var a=this.getSubscriptionId();return this.subscriptionCount++,this.subscriptions[a]=[a,t,e,r,i,o],a},s.prototype.remove=function(t){var e,r,i=[];if(O(t))e=function(e){return e[0]===t};else if(I(t))e=function(e){return e[1]===t};else if(E(t))e=function(e){return e[2]===t};else{if(void 0!==t)throw new n("BadArguments","Can only remove subscription by id, path or callback.");e=function(){return!0}}for(r in this.subscriptions)e(this.subscriptions[r])&&i.push(this.subscriptions[r][0]);return A(i,function(t){delete this.subscriptions[t]},this),i},s.prototype.trigger=function(t,e,r){var i=this.subscriptions[t];if(void 0===i)return!1;var o,a=i[1],s=i[2],c=i[3]||a,u=i[4],p=i[5],l={id:t,path:a};try{o=u(e)}catch(h){o=e}try{s.call(c,o,l)}catch(h){l.exception=h,l.fn=s,l.context=c,r(new n("RunTime","Exception thrown in subscription callback - "+h),l)}return{payload:o,additionalTopics:p}},c.prototype.getLatency=function(){var t=new Date(this.clientReportedCreateTimestamp),e=new Date;return e.getTime()-t.getTime()},c.factory=function(t){return new c(t)},p.isSupported=function(){return!!window.WebSocket};var H=function M(t){var e,r=[],n=[],i=function(t,i){return void 0===e&&void 0!==t&&(e=t,r=i,n.length&&setTimeout(function(){for(var t=0;t<n.length;t++)n[t]()},0)),e};return i.then=function(i,o){var a=M(t),s=function(){try{var t=e?i:o;if(E(t)){var n=function c(t){var e,r=0;try{if(t&&(R(t)||E(t))&&E(e=t.then)){if(t===a)throw new TypeError;e.call(t,function(){r++||c.apply(void 0,arguments)},function(t){r++||a(!1,[t])})}else a(!0,arguments)}catch(n){r++||a(!1,[n])}};n(t.apply(void 0,r||[]))}else a(e,r)}catch(s){a(!1,[s])}};return void 0!==e?setTimeout(s,0):n.push(s),a},t&&(i=t(i)),i},U=function(){var t=[function(){return new XMLHttpRequest},function(){return new ActiveXObject("Microsoft.XMLHTTP")},function(){return new ActiveXObject("MSXML2.XMLHTTP.3.0")},function(){return new ActiveXObject("MSXML2.XMLHTTP")}],e=null;return function(){if(null!==e)return e();for(var r=0,n=t.length;n>r;r++)try{var i=t[r],o=i();if(null!==o)return e=i,o}catch(a){continue}return function(){}}}();return f.prototype.getDuration=function(){return this.reqEnd.getTime()-this.reqStart.getTime()},f.prototype.getServerDuration=function(){return"abc"},f.prototype.isOk=function(){return this.xhr.status<300},m.prototype.setAuthorizationHeader=function(t,e){this.headers.Authorization="Basic "+btoa(t+":"+e)},m.prototype.setXhrHeaders=function(t){var e;for(e in this.headers)t.setRequestHeader(e,this.headers[e])},m.prototype.childAccountById=function(t){if(O(t))throw"accountId must be a int";return this.headers["X-Child-Account-By-Id"]=""+t,this},m.prototype.childAccountByCreatorRef=function(t){if(I(t))throw"creatorRef must be a string";return this.headers["X-Child-Account-By-CreatorRef"]=t,this},m.prototype.childAccountByEmail=function(t){if(I(t))throw"email must be a string";return this.headers["X-Child-Account-By-Email"]=t,this},g.prototype=new m,b.prototype=new m,y.prototype=new m,v.ApiKey=g,v.UsernamePassword=b,v.ClientKey=y,v.prototype.whoami=function(t){return d(this._makeReqOptions(t),"GET","whoami"),this},v.prototype.computers=function(t,e){var r="computers";return e&&e.computerSet&&(r+="/"+e.computerSet),d(this._makeReqOptions(t),"GET",r)},v.prototype.printers=function(t,e){var r="printers";return e&&(e.computerSet&&(r="computers/"+e.computerSet+"/printers"),e.printerSet&&(r+="/"+e.printerSet)),d(this._makeReqOptions(t),"GET",r)},v.prototype.printjobs=function(t,e){var r="printjobs";return e&&(e.printerSet&&(r="printers/"+e.printerSet+"/printjobs"),e.printjobSet&&(r+="/"+e.printjobSet)),d(this._makeReqOptions(t),"GET",r)},v.prototype.createPrintjob=function(t,e){return d(this._makeReqOptions(t),"POST","printjobs",e)},v.prototype.scales=function(t,e){return d(this._makeReqOptions(t),"GET",u(e,!1))},{WebSocket:p,HTTP:v,ScalesMeasurement:c,Error:n}}();